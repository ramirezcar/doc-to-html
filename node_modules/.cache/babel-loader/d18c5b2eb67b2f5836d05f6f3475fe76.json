{"ast":null,"code":"\"use strict\";\n\nmodule.exports = function (Promise, apiRejection, tryConvertToPromise, createContext, INTERNAL, debug) {\n  var util = require(\"./util\");\n\n  var TypeError = require(\"./errors\").TypeError;\n\n  var inherits = require(\"./util\").inherits;\n\n  var errorObj = util.errorObj;\n  var tryCatch = util.tryCatch;\n  var NULL = {};\n\n  function thrower(e) {\n    setTimeout(function () {\n      throw e;\n    }, 0);\n  }\n\n  function castPreservingDisposable(thenable) {\n    var maybePromise = tryConvertToPromise(thenable);\n\n    if (maybePromise !== thenable && typeof thenable._isDisposable === \"function\" && typeof thenable._getDisposer === \"function\" && thenable._isDisposable()) {\n      maybePromise._setDisposable(thenable._getDisposer());\n    }\n\n    return maybePromise;\n  }\n\n  function dispose(resources, inspection) {\n    var i = 0;\n    var len = resources.length;\n    var ret = new Promise(INTERNAL);\n\n    function iterator() {\n      if (i >= len) return ret._fulfill();\n      var maybePromise = castPreservingDisposable(resources[i++]);\n\n      if (maybePromise instanceof Promise && maybePromise._isDisposable()) {\n        try {\n          maybePromise = tryConvertToPromise(maybePromise._getDisposer().tryDispose(inspection), resources.promise);\n        } catch (e) {\n          return thrower(e);\n        }\n\n        if (maybePromise instanceof Promise) {\n          return maybePromise._then(iterator, thrower, null, null, null);\n        }\n      }\n\n      iterator();\n    }\n\n    iterator();\n    return ret;\n  }\n\n  function Disposer(data, promise, context) {\n    this._data = data;\n    this._promise = promise;\n    this._context = context;\n  }\n\n  Disposer.prototype.data = function () {\n    return this._data;\n  };\n\n  Disposer.prototype.promise = function () {\n    return this._promise;\n  };\n\n  Disposer.prototype.resource = function () {\n    if (this.promise().isFulfilled()) {\n      return this.promise().value();\n    }\n\n    return NULL;\n  };\n\n  Disposer.prototype.tryDispose = function (inspection) {\n    var resource = this.resource();\n    var context = this._context;\n    if (context !== undefined) context._pushContext();\n    var ret = resource !== NULL ? this.doDispose(resource, inspection) : null;\n    if (context !== undefined) context._popContext();\n\n    this._promise._unsetDisposable();\n\n    this._data = null;\n    return ret;\n  };\n\n  Disposer.isDisposer = function (d) {\n    return d != null && typeof d.resource === \"function\" && typeof d.tryDispose === \"function\";\n  };\n\n  function FunctionDisposer(fn, promise, context) {\n    this.constructor$(fn, promise, context);\n  }\n\n  inherits(FunctionDisposer, Disposer);\n\n  FunctionDisposer.prototype.doDispose = function (resource, inspection) {\n    var fn = this.data();\n    return fn.call(resource, resource, inspection);\n  };\n\n  function maybeUnwrapDisposer(value) {\n    if (Disposer.isDisposer(value)) {\n      this.resources[this.index]._setDisposable(value);\n\n      return value.promise();\n    }\n\n    return value;\n  }\n\n  function ResourceList(length) {\n    this.length = length;\n    this.promise = null;\n    this[length - 1] = null;\n  }\n\n  ResourceList.prototype._resultCancelled = function () {\n    var len = this.length;\n\n    for (var i = 0; i < len; ++i) {\n      var item = this[i];\n\n      if (item instanceof Promise) {\n        item.cancel();\n      }\n    }\n  };\n\n  Promise.using = function () {\n    var len = arguments.length;\n    if (len < 2) return apiRejection(\"you must pass at least 2 arguments to Promise.using\");\n    var fn = arguments[len - 1];\n\n    if (typeof fn !== \"function\") {\n      return apiRejection(\"expecting a function but got \" + util.classString(fn));\n    }\n\n    var input;\n    var spreadArgs = true;\n\n    if (len === 2 && Array.isArray(arguments[0])) {\n      input = arguments[0];\n      len = input.length;\n      spreadArgs = false;\n    } else {\n      input = arguments;\n      len--;\n    }\n\n    var resources = new ResourceList(len);\n\n    for (var i = 0; i < len; ++i) {\n      var resource = input[i];\n\n      if (Disposer.isDisposer(resource)) {\n        var disposer = resource;\n        resource = resource.promise();\n\n        resource._setDisposable(disposer);\n      } else {\n        var maybePromise = tryConvertToPromise(resource);\n\n        if (maybePromise instanceof Promise) {\n          resource = maybePromise._then(maybeUnwrapDisposer, null, null, {\n            resources: resources,\n            index: i\n          }, undefined);\n        }\n      }\n\n      resources[i] = resource;\n    }\n\n    var reflectedResources = new Array(resources.length);\n\n    for (var i = 0; i < reflectedResources.length; ++i) {\n      reflectedResources[i] = Promise.resolve(resources[i]).reflect();\n    }\n\n    var resultPromise = Promise.all(reflectedResources).then(function (inspections) {\n      for (var i = 0; i < inspections.length; ++i) {\n        var inspection = inspections[i];\n\n        if (inspection.isRejected()) {\n          errorObj.e = inspection.error();\n          return errorObj;\n        } else if (!inspection.isFulfilled()) {\n          resultPromise.cancel();\n          return;\n        }\n\n        inspections[i] = inspection.value();\n      }\n\n      promise._pushContext();\n\n      fn = tryCatch(fn);\n      var ret = spreadArgs ? fn.apply(undefined, inspections) : fn(inspections);\n\n      var promiseCreated = promise._popContext();\n\n      debug.checkForgottenReturns(ret, promiseCreated, \"Promise.using\", promise);\n      return ret;\n    });\n    var promise = resultPromise.lastly(function () {\n      var inspection = new Promise.PromiseInspection(resultPromise);\n      return dispose(resources, inspection);\n    });\n    resources.promise = promise;\n\n    promise._setOnCancel(resources);\n\n    return promise;\n  };\n\n  Promise.prototype._setDisposable = function (disposer) {\n    this._bitField = this._bitField | 131072;\n    this._disposer = disposer;\n  };\n\n  Promise.prototype._isDisposable = function () {\n    return (this._bitField & 131072) > 0;\n  };\n\n  Promise.prototype._getDisposer = function () {\n    return this._disposer;\n  };\n\n  Promise.prototype._unsetDisposable = function () {\n    this._bitField = this._bitField & ~131072;\n    this._disposer = undefined;\n  };\n\n  Promise.prototype.disposer = function (fn) {\n    if (typeof fn === \"function\") {\n      return new FunctionDisposer(fn, this, createContext());\n    }\n\n    throw new TypeError();\n  };\n};","map":{"version":3,"sources":["C:/Users/Carlos/Desktop/Coding/doc-to-html/node_modules/bluebird/js/release/using.js"],"names":["module","exports","Promise","apiRejection","tryConvertToPromise","createContext","INTERNAL","debug","util","require","TypeError","inherits","errorObj","tryCatch","NULL","thrower","e","setTimeout","castPreservingDisposable","thenable","maybePromise","_isDisposable","_getDisposer","_setDisposable","dispose","resources","inspection","i","len","length","ret","iterator","_fulfill","tryDispose","promise","_then","Disposer","data","context","_data","_promise","_context","prototype","resource","isFulfilled","value","undefined","_pushContext","doDispose","_popContext","_unsetDisposable","isDisposer","d","FunctionDisposer","fn","constructor$","call","maybeUnwrapDisposer","index","ResourceList","_resultCancelled","item","cancel","using","arguments","classString","input","spreadArgs","Array","isArray","disposer","reflectedResources","resolve","reflect","resultPromise","all","then","inspections","isRejected","error","apply","promiseCreated","checkForgottenReturns","lastly","PromiseInspection","_setOnCancel","_bitField","_disposer"],"mappings":"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","sourcesContent":["\"use strict\";\nmodule.exports = function (Promise, apiRejection, tryConvertToPromise,\n    createContext, INTERNAL, debug) {\n    var util = require(\"./util\");\n    var TypeError = require(\"./errors\").TypeError;\n    var inherits = require(\"./util\").inherits;\n    var errorObj = util.errorObj;\n    var tryCatch = util.tryCatch;\n    var NULL = {};\n\n    function thrower(e) {\n        setTimeout(function(){throw e;}, 0);\n    }\n\n    function castPreservingDisposable(thenable) {\n        var maybePromise = tryConvertToPromise(thenable);\n        if (maybePromise !== thenable &&\n            typeof thenable._isDisposable === \"function\" &&\n            typeof thenable._getDisposer === \"function\" &&\n            thenable._isDisposable()) {\n            maybePromise._setDisposable(thenable._getDisposer());\n        }\n        return maybePromise;\n    }\n    function dispose(resources, inspection) {\n        var i = 0;\n        var len = resources.length;\n        var ret = new Promise(INTERNAL);\n        function iterator() {\n            if (i >= len) return ret._fulfill();\n            var maybePromise = castPreservingDisposable(resources[i++]);\n            if (maybePromise instanceof Promise &&\n                maybePromise._isDisposable()) {\n                try {\n                    maybePromise = tryConvertToPromise(\n                        maybePromise._getDisposer().tryDispose(inspection),\n                        resources.promise);\n                } catch (e) {\n                    return thrower(e);\n                }\n                if (maybePromise instanceof Promise) {\n                    return maybePromise._then(iterator, thrower,\n                                              null, null, null);\n                }\n            }\n            iterator();\n        }\n        iterator();\n        return ret;\n    }\n\n    function Disposer(data, promise, context) {\n        this._data = data;\n        this._promise = promise;\n        this._context = context;\n    }\n\n    Disposer.prototype.data = function () {\n        return this._data;\n    };\n\n    Disposer.prototype.promise = function () {\n        return this._promise;\n    };\n\n    Disposer.prototype.resource = function () {\n        if (this.promise().isFulfilled()) {\n            return this.promise().value();\n        }\n        return NULL;\n    };\n\n    Disposer.prototype.tryDispose = function(inspection) {\n        var resource = this.resource();\n        var context = this._context;\n        if (context !== undefined) context._pushContext();\n        var ret = resource !== NULL\n            ? this.doDispose(resource, inspection) : null;\n        if (context !== undefined) context._popContext();\n        this._promise._unsetDisposable();\n        this._data = null;\n        return ret;\n    };\n\n    Disposer.isDisposer = function (d) {\n        return (d != null &&\n                typeof d.resource === \"function\" &&\n                typeof d.tryDispose === \"function\");\n    };\n\n    function FunctionDisposer(fn, promise, context) {\n        this.constructor$(fn, promise, context);\n    }\n    inherits(FunctionDisposer, Disposer);\n\n    FunctionDisposer.prototype.doDispose = function (resource, inspection) {\n        var fn = this.data();\n        return fn.call(resource, resource, inspection);\n    };\n\n    function maybeUnwrapDisposer(value) {\n        if (Disposer.isDisposer(value)) {\n            this.resources[this.index]._setDisposable(value);\n            return value.promise();\n        }\n        return value;\n    }\n\n    function ResourceList(length) {\n        this.length = length;\n        this.promise = null;\n        this[length-1] = null;\n    }\n\n    ResourceList.prototype._resultCancelled = function() {\n        var len = this.length;\n        for (var i = 0; i < len; ++i) {\n            var item = this[i];\n            if (item instanceof Promise) {\n                item.cancel();\n            }\n        }\n    };\n\n    Promise.using = function () {\n        var len = arguments.length;\n        if (len < 2) return apiRejection(\n                        \"you must pass at least 2 arguments to Promise.using\");\n        var fn = arguments[len - 1];\n        if (typeof fn !== \"function\") {\n            return apiRejection(\"expecting a function but got \" + util.classString(fn));\n        }\n        var input;\n        var spreadArgs = true;\n        if (len === 2 && Array.isArray(arguments[0])) {\n            input = arguments[0];\n            len = input.length;\n            spreadArgs = false;\n        } else {\n            input = arguments;\n            len--;\n        }\n        var resources = new ResourceList(len);\n        for (var i = 0; i < len; ++i) {\n            var resource = input[i];\n            if (Disposer.isDisposer(resource)) {\n                var disposer = resource;\n                resource = resource.promise();\n                resource._setDisposable(disposer);\n            } else {\n                var maybePromise = tryConvertToPromise(resource);\n                if (maybePromise instanceof Promise) {\n                    resource =\n                        maybePromise._then(maybeUnwrapDisposer, null, null, {\n                            resources: resources,\n                            index: i\n                    }, undefined);\n                }\n            }\n            resources[i] = resource;\n        }\n\n        var reflectedResources = new Array(resources.length);\n        for (var i = 0; i < reflectedResources.length; ++i) {\n            reflectedResources[i] = Promise.resolve(resources[i]).reflect();\n        }\n\n        var resultPromise = Promise.all(reflectedResources)\n            .then(function(inspections) {\n                for (var i = 0; i < inspections.length; ++i) {\n                    var inspection = inspections[i];\n                    if (inspection.isRejected()) {\n                        errorObj.e = inspection.error();\n                        return errorObj;\n                    } else if (!inspection.isFulfilled()) {\n                        resultPromise.cancel();\n                        return;\n                    }\n                    inspections[i] = inspection.value();\n                }\n                promise._pushContext();\n\n                fn = tryCatch(fn);\n                var ret = spreadArgs\n                    ? fn.apply(undefined, inspections) : fn(inspections);\n                var promiseCreated = promise._popContext();\n                debug.checkForgottenReturns(\n                    ret, promiseCreated, \"Promise.using\", promise);\n                return ret;\n            });\n\n        var promise = resultPromise.lastly(function() {\n            var inspection = new Promise.PromiseInspection(resultPromise);\n            return dispose(resources, inspection);\n        });\n        resources.promise = promise;\n        promise._setOnCancel(resources);\n        return promise;\n    };\n\n    Promise.prototype._setDisposable = function (disposer) {\n        this._bitField = this._bitField | 131072;\n        this._disposer = disposer;\n    };\n\n    Promise.prototype._isDisposable = function () {\n        return (this._bitField & 131072) > 0;\n    };\n\n    Promise.prototype._getDisposer = function () {\n        return this._disposer;\n    };\n\n    Promise.prototype._unsetDisposable = function () {\n        this._bitField = this._bitField & (~131072);\n        this._disposer = undefined;\n    };\n\n    Promise.prototype.disposer = function (fn) {\n        if (typeof fn === \"function\") {\n            return new FunctionDisposer(fn, this, createContext());\n        }\n        throw new TypeError();\n    };\n\n};\n"]},"metadata":{},"sourceType":"script"}